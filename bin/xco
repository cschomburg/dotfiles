#!/bin/sh

REPO_URL=git@blackhybrid
CODE_DIR=$HOME/code

clone_code () {
	REPO=$1
	if [ -e "$CODE_DIR/$REPO" ]; then
		return
	fi
	
	git clone $REPO_URL:$REPO "$CODE_DIR/$REPO"
}

check () {
	curr_dir=$(pwd)
	root_dir=${1:-~/code}
	for file in $(find "$root_dir" -name .git); do
		repo=$(dirname "$file")
		cd "$repo"
		if ! git diff --exit-code > /dev/null; then
			echo $repo has unstaged changes
		elif ! git diff --cached --exit-code > /dev/null; then
			echo $repo has uncommitted changes
		elif [ -n "$(git cherry 2>/dev/null)" ]; then
			echo $repo has unpushed changes
		fi
		cd "$curr_dir"
	done
}

if [ -z "$1" ]; then
	cat <<EOF
Usage: xco <command> [<args>...]

commands:
   clone <repo>
   check [<dir>]
EOF
exit 1
fi

cmd=$1
shift

case $cmd in
	clone) clone_code $1 ;;
	check) check $@ ;;
	*) echo "unknown command: $2"
esac

#!/bin/bash
# --------------------------------------------
#  Install extension from 
#  Gnome Shell Extensions site
#  Depends on :
#   * unzip
#  Parameter :
#   $1 = Target Gnome Shell version
#   $2 = Extension ID on the site
#  Revision history :
#  13/07/2013 - Creation by N. Bernaerts
# -------------------------------------------

set -e

source ${1}

if [ -z "$id" ]; then
	echo 'failed=True msg="Module needs id= argument"'
	exit 0
fi

GNOME_SITE="https://extensions.gnome.org"
GNOME_VERSION=$(gnome-shell --version | cut -d' ' -f 3)
EXTENSION_ID=$id
EXTENSION_PATH="$HOME/.local/share/gnome-shell/extensions";

if [ -n "$uuid" &&  -e "$EXTENSION_PATH/$uuid" ]; then
	echo 'changed=False'
	exit 0
fi

# get extension description
wget -q -O /tmp/extension.txt "$GNOME_SITE/extension-info/?pk=$EXTENSION_ID&shell_version=$GNOME_VERSION"

EXTENSION_UUID=`cat /tmp/extension.txt | grep "uuid" | sed 's/^.*uuid[\": ]*\([^\"]*\).*$/\1/'`
EXTENSION_URL=`cat /tmp/extension.txt | grep "download_url" | sed 's/^.*download_url[\": ]*\([^\"]*\).*$/\1/'`

if [ -z "$EXTENSION_URL" ]; then
	echo 'failed=True msg="No extension for Gnome Shell' $GNOME_VERSION 'found"'
	exit 0
fi

if [ -e "$EXTENSION_PATH/$EXTENSION_UUID" ]; then
	echo 'changed=False'
	exit 0
fi

# download extension archive
wget -q -O /tmp/extension.zip "$GNOME_SITE$EXTENSION_URL" > /dev/null

# unzip extension to installation folder
mkdir -p "$EXTENSION_PATH/$EXTENSION_UUID"
unzip -qq /tmp/extension.zip -d "$EXTENSION_PATH/$EXTENSION_UUID" > /dev/null

# remove temporary files
rm -f /tmp/extension.txt
rm -f /tmp/extension.zip

echo "changed=True"
exit 0
